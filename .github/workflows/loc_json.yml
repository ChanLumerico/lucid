name: Update LOC Badge JSON

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-loc-badge:
    runs-on: ubuntu-latest

    steps:
      # push일 때만 release-x.y.z 형식 검사
      - name: Check commit message matches release-x.y.z
        if: github.event_name == 'push'
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          echo "Commit message: $COMMIT_MSG"
          if [[ ! "$COMMIT_MSG" =~ ^release-[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Not a release commit. Skipping LOC badge update."
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v4

      # CodeTabs → Total lines만 추출 → loc_badge.json 생성
      - name: Fetch LOC and build badge JSON
        run: |
          curl -sL "https://api.codetabs.com/v1/loc/?github=ChanLumerico/lucid&branch=main&ignored=docs,devlog,review" > tmp.json

          python - <<'PY'
          import json
          data = json.load(open("tmp.json","r",encoding="utf-8"))
          total = next(x for x in data if x.get("language") == "Total")
          out = {"lines": total["lines"]}
          with open("loc_badge.json","w",encoding="utf-8") as f:
              json.dump(out, f)
          print("loc_badge.json:", out)
          PY

          rm tmp.json

      - name: Commit & push loc_badge.json
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add loc_badge.json
          git commit -m "chore: update loc badge json" || exit 0
          git push